#!/bin/bash
set -e

DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null && pwd )"
source ${DIR}/../../scripts/utils.sh

if [ ! -f ${DIR}/vertica-jdbc.jar ]
then
     # install deps
     log "Getting vertica-jdbc.jar from vertica-client-9.3.1-0.x86_64.tar.gz"
     wget https://www.vertica.com/client_drivers/9.3.x/9.3.1-0/vertica-client-9.3.1-0.x86_64.tar.gz
     tar xvfz ${DIR}/vertica-client-9.3.1-0.x86_64.tar.gz
     cp ${DIR}/opt/vertica/java/lib/vertica-jdbc.jar ${DIR}/
     rm -rf ${DIR}/opt
     rm -f ${DIR}/vertica-client-9.3.1-0.x86_64.tar.gz
fi


if [ ! -f ${DIR}/producer/target/producer-1.0.0-jar-with-dependencies.jar ]
then
     log "Building jar for producer"
     docker run -it --rm -e TAG=$TAG_BASE -e KAFKA_CLIENT_TAG=$KAFKA_CLIENT_TAG -v "${DIR}/producer":/usr/src/mymaven -v "$HOME/.m2":/root/.m2 -v "${DIR}/producer/target:/usr/src/mymaven/target" -w /usr/src/mymaven maven:3.6.1-jdk-11 mvn package
fi
exit 0

${DIR}/../../environment/plaintext/start.sh "${PWD}/docker-compose.plaintext-repro-tombstone.yml"


sleep 60

log "Sending messages to topic customer using java producer from connect-vertica-sink/producer"

log "Creating JDBC Vertica sink connector"
docker exec connect \
     curl -X PUT \
     -H "Content-Type: application/json" \
     --data '{
               "connector.class" : "io.confluent.connect.jdbc.JdbcSinkConnector",
                    "tasks.max" : "1",
                    "connection.url": "jdbc:vertica://vertica:5433/docker?user=dbadmin&password=",
                    "auto.create": "true",
                    "pk.mode": "record_key",
                    "pk.fields": "ID",
                    "auto.create": true,
                    "auto.evolve": false,
                    "key.converter": "org.apache.kafka.connect.converters.LongConverter",
                    "value.converter" : "Avro",
                    "value.converter.schema.registry.url":"http://schema-registry:8081",
                    "topics": "customer"
          }' \
     http://localhost:8083/connectors/jdbc-vertica-sink/config | jq .

sleep 10

log "Check data is in Vertica"
docker exec -i vertica /opt/vertica/bin/vsql -hlocalhost -Udbadmin << EOF
select * from customer;
EOF

# ListID | NormalizedHashItemID | URL  |   MyFloatValue    |  MyTimestamp  | ID
# --------+----------------------+------+-------------------+---------------+----
#       0 |                    0 | url0 | 0.282263566813515 | 1594889817338 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889821693 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889821693 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889823717 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889824726 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889825732 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889826738 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889827750 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889828760 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889829768 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889830774 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889831834 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889831834 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889833858 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889834869 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889835877 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889836885 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889837893 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889838899 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889839905 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889840911 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889841916 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889841916 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889843928 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889844932 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889845938 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889846945 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889847949 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889848921 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889849926 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889850941 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889851947 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889851947 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889853960 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889854967 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889855975 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889856984 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889857992 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889858998 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889860006 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889861012 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889862018 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889862018 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889864028 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889865033 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889866039 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889867044 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889868050 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889869055 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889870059 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889871064 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889872069 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889872069 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889874083 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889875088 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889876093 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889877099 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889878104 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889879075 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889880079 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889881083 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889882087 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889882087 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889884096 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889885102 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889886106 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889887111 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889888114 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889889118 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889890122 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889891127 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889892132 |  1
#       1 |                    1 | url1 | 0.282263566813515 | 1594889892132 |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889894144 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889895151 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889896157 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889897161 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889898169 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889899172 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889900177 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889901186 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889902193 |  1
#         |                      |      |                   |               |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889904207 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889905211 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889906218 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889907225 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889908231 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889909200 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889910205 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889911211 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889912217 |  1
#         |                      |      |                   |               |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889914229 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889915235 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889916241 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889917246 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889918252 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889919259 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889920266 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889921272 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889922291 |  1
#         |                      |      |                   |               |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889924301 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889925306 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889926312 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889927317 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889928323 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889929327 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889930334 |  9
#       0 |                    0 | url0 | 0.282263566813515 | 1594889931341 |  0
#       1 |                    1 | url1 | 0.282263566813515 | 1594889932345 |  1
#         |                      |      |                   |               |  2
#       3 |                    3 | url3 | 0.282263566813515 | 1594889934355 |  3
#       4 |                    4 | url4 | 0.282263566813515 | 1594889935361 |  4
#       5 |                    5 | url5 | 0.282263566813515 | 1594889936368 |  5
#       6 |                    6 | url6 | 0.282263566813515 | 1594889937373 |  6
#       7 |                    7 | url7 | 0.282263566813515 | 1594889938343 |  7
#       8 |                    8 | url8 | 0.282263566813515 | 1594889939349 |  8
#       9 |                    9 | url9 | 0.282263566813515 | 1594889940354 |  9
# (120 rows)